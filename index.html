<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç²¾ç°¡ç‰ˆ Supabase éƒ¨è½æ ¼</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .post-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--background-alt);
        }
        .comment-item {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            font-size: 0.9em;
        }
        .new-badge { color: red; font-size: 0.8em; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
        <h1>æˆ‘çš„ Supabase éƒ¨è½æ ¼ ğŸš€</h1>
        <div id="auth-ui">
            <span id="user-display" style="margin-right: 10px; font-weight: bold;">æª¢æŸ¥èº«åˆ†ä¸­...</span>
        </div>
    </header>

    <details id="auth-forms">
        <summary>ğŸ‘¤ å¸³è™Ÿç™»å…¥ / è¨»å†Š</summary>
        <div style="margin-top: 20px; padding: 20px; border: 1px dashed #ccc;">
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" placeholder="å¯†ç¢¼">
            <br>
            <button onclick="handleSignUp()">è¨»å†Š</button>
            <button onclick="handleSignIn()">ç™»å…¥</button>
            <button onclick="handleSignOut()" style="background-color: #ef4444;">ç™»å‡º</button>
        </div>
    </details>

    <details id="profile-section" style="display: none; margin-bottom: 20px;">
        <summary>âš™ï¸ ä¿®æ”¹å€‹äººæš±ç¨±</summary>
        <div style="padding: 15px; border: 1px solid #ddd; margin-top: 10px;">
            <input type="text" id="edit-username" placeholder="è¼¸å…¥ä½ æƒ³é¡¯ç¤ºçš„åå­—">
            <button id="btn-update-profile" onclick="updateProfile()">å„²å­˜ä¿®æ”¹</button>
        </div>
    </details>

    <hr>

    <div id="post-section">
        <h2>âœï¸ ç™¼ä½ˆæ–°æ–‡ç« </h2>
        <input type="text" id="post-title" placeholder="æ–‡ç« æ¨™é¡Œ">
        <textarea id="post-content" placeholder="å¯«é»ä»€éº¼..." rows="4"></textarea>
        <label>ä¸Šå‚³åœ–ç‰‡ï¼š</label>
        <input type="file" id="post-image" accept="image/*">
        <button id="btn-publish" onclick="createPost()">ç™¼ä½ˆæ–‡ç« </button>
    </div>

    <hr>

    <h2>ğŸ“– æœ€æ–°æ–‡ç« </h2>
    <div id="post-container">è¼‰å…¥æ–‡ç« ä¸­...</div>

    <script>
        // --- åˆå§‹åŒ– Supabase ---
        const SUPABASE_URL = 'https://llhiisczjckqcwdvugih.supabase.co';
        // è«‹ç¢ºä¿é€™è£¡æ›´æ›æˆä½ å°ˆæ¡ˆä¸­é•·åº¦ä»¥ eyJ é–‹é ­çš„ anon key
        const SUPABASE_KEY = 'YOUR_LONG_ANON_KEY_HERE'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 1. èº«åˆ†é©—è­‰èˆ‡ç‹€æ…‹ç›£è½ ---
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            const profileSection = document.getElementById('profile-section');
            const userDisplay = document.getElementById('user-display');
            const authForms = document.getElementById('auth-forms');
            
            if (session && session.user) {
                profileSection.style.display = 'block'; 
                if(authForms) authForms.removeAttribute('open'); 

                try {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('username')
                        .eq('id', session.user.id)
                        .maybeSingle();

                    if (data && data.username) {
                        document.getElementById('edit-username').value = data.username;
                        userDisplay.innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${data.username}`;
                    } else {
                        userDisplay.innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${session.user.email} (å°šæœªè¨­å®šæš±ç¨±)`;
                    }
                } catch (err) {
                    userDisplay.innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${session.user.email}`;
                }
            } else {
                profileSection.style.display = 'none';
                userDisplay.innerText = 'å°šæœªç™»å…¥';
            }
            fetchPosts();
        });

        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) alert('è¨»å†Šå¤±æ•—ï¼š' + error.message);
            else alert('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰ã€‚');
        }

        async function handleSignIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
        }

        async function handleSignOut() {
            await supabaseClient.auth.signOut();
            location.reload(); 
        }

        // --- 2. æ–‡ç« æ“ä½œ ---
        async function fetchPosts() {
            const container = document.getElementById('post-container');
            const { data, error } = await supabaseClient
                .from('posts')
                .select('id, title, content, image_url, created_at')
                .order('created_at', { ascending: false });

            if (error) container.innerText = 'è¼‰å…¥æ–‡ç« å¤±æ•—ï¼š' + error.message;
            else {
                container.innerHTML = data.length === 0 ? 'ç›®å‰æ²’æœ‰æ–‡ç« ' : 
                    data.map(post => renderPostHTML(post)).join('');
            }
        }

        async function createPost() {
            const titleInput = document.getElementById('post-title');
            const contentInput = document.getElementById('post-content');
            const fileInput = document.getElementById('post-image');
            const btn = document.getElementById('btn-publish');
            
            if (!titleInput.value) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');
            btn.disabled = true; btn.innerText = 'ä¸Šå‚³ä¸­...';

            try {
                let publicUrl = null;
                const file = fileInput.files[0];
                if (file) {
                    const fileName = `${Date.now()}_${file.name}`;
                    const { error: uploadError } = await supabaseClient.storage.from('images').upload(fileName, file);
                    if (uploadError) throw uploadError; // ä¿®æ­£è©•è«–ç¬¬ 4 é»ï¼šæª¢æŸ¥ä¸Šå‚³éŒ¯èª¤
                    
                    const { data: urlData } = supabaseClient.storage.from('images').getPublicUrl(fileName);
                    publicUrl = urlData.publicUrl;
                }
                const { error: dbError } = await supabaseClient.from('posts').insert([
                    { title: titleInput.value, content: contentInput.value, image_url: publicUrl }
                ]);
                if (dbError) throw dbError;
                alert('ç™¼ä½ˆæˆåŠŸï¼');
                titleInput.value = ''; contentInput.value = ''; fileInput.value = '';
                fetchPosts();
            } catch (err) {
                alert('ç™¼ä½ˆå¤±æ•—ï¼š' + err.message);
            } finally {
                btn.disabled = false; btn.innerText = 'ç™¼ä½ˆæ–‡ç« ';
            }
        }

        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ–‡ç« å—ï¼Ÿ')) return;
            const { error } = await supabaseClient.from('posts').delete().eq('id', postId);
            if (error) alert('åˆªé™¤å¤±æ•—ï¼ˆæ¬Šé™ä¸è¶³ï¼‰ï¼š' + error.message);
            else fetchPosts();
        }

        // --- 3. ç•™è¨€ç³»çµ± ---
        function renderPostHTML(post) {
            const imgHtml = post.image_url ? `<img src="${post.image_url}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">` : '';
            return `
                <div class="post-card">
                    <h3>${post.title}</h3>
                    <p style="white-space: pre-wrap;">${post.content}</p>
                    ${imgHtml}
                    <hr style="opacity: 0.3;">
                    <button onclick="toggleComments('${post.id}')">