<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ Supabase éƒ¨è½æ ¼</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* é¡å¤–å¾®èª¿ä¸€é»é»æ¨£å¼ */
        .post-card {
            border: 1px solid var(--border); /* ä½¿ç”¨ Water.css çš„è®Šæ•¸ */
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--background-alt);
        }
        .new-badge {
            color: red;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body>

    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
        <h1>æˆ‘çš„ Supabase éƒ¨è½æ ¼ ğŸš€</h1>
        <div id="auth-ui">
            <span id="user-display" style="margin-right: 10px; font-weight: bold;"></span>
            </div>
    </header>

    <details id="auth-forms">
        <summary>é»æ­¤å±•é–‹ï¼šç™»å…¥æˆ–è¨»å†Š</summary>
        <div style="margin-top: 20px; padding: 20px; border: 1px dashed #ccc;">
            <h3>å¸³è™Ÿç®¡ç†</h3>
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" placeholder="å¯†ç¢¼">
            <br>
            <button onclick="handleSignUp()">è¨»å†Š</button>
            <button onclick="handleSignIn()">ç™»å…¥</button>
            <button onclick="handleSignOut()" style="background-color: #ef4444;">ç™»å‡º</button>
        </div>
    </details>

    <hr>

    <div id="post-section">
        <h2>âœï¸ ç™¼ä½ˆæ–°æ–‡ç« </h2>
        <input type="text" id="post-title" placeholder="æ–‡ç« æ¨™é¡Œ">
        <textarea id="post-content" placeholder="å¯«é»ä»€éº¼..." rows="4"></textarea>
        <label for="post-image">ä¸Šå‚³åœ–ç‰‡ï¼š</label>
        <input type="file" id="post-image" accept="image/*">
        <button id="btn-publish" onclick="createPost()">ç™¼ä½ˆæ–‡ç« </button>
    </div>

    <hr>

    <h2>ğŸ“– æœ€æ–°æ–‡ç« </h2>
    <div id="post-container">è¼‰å…¥ä¸­...</div>

    <script>
        // --- è¨­å®šå€ ---
        const SUPABASE_URL = 'https://llhiisczjckqcwdvugih.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_2y3NauD1KSlPs4U1k5D9KA_hD9OVGXj'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        // --- 1. èº«åˆ†é©—è­‰é‚è¼¯ ---
        
        // ç›£è½ç‹€æ…‹æ”¹è®Š
        supabaseClient.auth.onAuthStateChange((event, session) => {
            const userDisplay = document.getElementById('user-display');
            const authDetails = document.getElementById('auth-forms');
            
            if (session && session.user) {
                userDisplay.innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${session.user.email}`;
                // ç™»å…¥å¾Œè‡ªå‹•æ”¶èµ·ç™»å…¥æ¡†
                authDetails.removeAttribute('open'); 
            } else {
                userDisplay.innerText = 'å°šæœªç™»å…¥';
            }
        });

        async function handleSignUp() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            const { error } = await supabaseClient.auth.signUp({ email, password })
            if (error) alert('è¨»å†Šå¤±æ•—ï¼š' + error.message)
            else alert('è¨»å†ŠæˆåŠŸï¼è«‹é©—è­‰ä¿¡ç®±ã€‚')
        }

        async function handleSignIn() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password })
            if (error) alert('ç™»å…¥å¤±æ•—ï¼š' + error.message)
            else alert('ç™»å…¥æˆåŠŸï¼')
        }

        async function handleSignOut() {
            await supabaseClient.auth.signOut()
            alert('å·²ç™»å‡º')
            // é‡æ•´é é¢ç¢ºä¿ç‹€æ…‹ä¹¾æ·¨
            location.reload(); 
        }

        // --- 2. è³‡æ–™æ“ä½œé‚è¼¯ ---

        // è®€å–æ–‡ç« 
        async function fetchPosts() {
            const container = document.getElementById('post-container')
            
            const { data, error } = await supabaseClient
                .from('posts')
                .select('id, title, content, image_url, created_at') // å¤šæŠ“ created_at
                .order('created_at', { ascending: false })

            if (error) {
                container.innerText = 'éŒ¯èª¤ï¼š' + error.message
            } else {
                if (data.length === 0) {
                    container.innerText = 'ç›®å‰æ²’æœ‰æ–‡ç« ï¼Œå¿«ä¾†ç™¼ç¬¬ä¸€ç¯‡å§ï¼';
                    return;
                }
                container.innerHTML = data.map(post => renderPostHTML(post)).join('')
            }
        }

        // ç™¼ä½ˆæ–‡ç«  (å«åœ–ç‰‡ä¸Šå‚³)
        async function createPost() {
            const titleInput = document.getElementById('post-title');
            const contentInput = document.getElementById('post-content');
            const fileInput = document.getElementById('post-image');
            const btn = document.getElementById('btn-publish');
            
            // ç°¡å–®é©—è­‰
            if (!titleInput.value) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');

            // 1. é–å®šæŒ‰éˆ•
            btn.disabled = true;
            btn.innerText = 'ç™¼å¸ƒä¸­...';

            try {
                let publicUrl = null;
                const file = fileInput.files[0];

                // 2. å¦‚æœæœ‰åœ–ç‰‡ï¼Œå…ˆä¸Šå‚³
                if (file) {
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`; // æ·¨åŒ–æª”å
                    const { error: uploadError } = await supabaseClient.storage
                        .from('images').upload(fileName, file);

                    if (uploadError) throw new Error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ' + uploadError.message);

                    const { data } = supabaseClient.storage.from('images').getPublicUrl(fileName);
                    publicUrl = data.publicUrl;
                }

                // 3. å¯«å…¥è³‡æ–™åº«
                const { error: dbError } = await supabaseClient.from('posts').insert([
                    { title: titleInput.value, content: contentInput.value, image_url: publicUrl }
                ]);

                if (dbError) throw new Error(dbError.message);

                alert('ğŸ‰ ç™¼ä½ˆæˆåŠŸï¼');
                
                // æ¸…ç©ºè¡¨å–®
                titleInput.value = '';
                contentInput.value = '';
                fileInput.value = '';

            } catch (err) {
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
            } finally {
                // 4. æ¢å¾©æŒ‰éˆ•
                btn.disabled = false;
                btn.innerText = 'ç™¼ä½ˆæ–‡ç« ';
            }
        }

        // åˆªé™¤æ–‡ç« 
        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ–‡ç« å—ï¼Ÿ')) return;

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return alert('è«‹å…ˆç™»å…¥ï¼');

            const { error, count } = await supabaseClient
                .from('posts')
                .delete({ count: 'exact' })
                .eq('id', postId);

            if (error) alert('éŒ¯èª¤ï¼š' + error.message);
            else if (count === 0) alert('åˆªé™¤å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ï¼ˆä½ ä¸æ˜¯ä½œè€…ï¼‰');
            else {
                alert('åˆªé™¤æˆåŠŸ');
                // å‰ç«¯ä»‹é¢ç›´æ¥ç§»é™¤è©²å…ƒç´  (ä¸ç”¨é‡æ•´)
                const el = document.getElementById(`post-${postId}`);
                if (el) el.remove();
            }
        }

        // --- 3. è¼”åŠ©å‡½æ•¸èˆ‡ Realtime ---

        // çµ±ä¸€ç”¢å‡º HTML çš„æ¨¡æ¿å‡½æ•¸
        function renderPostHTML(post, isNew = false) {
            const imgHtml = post.image_url 
                ? `<img src="${post.image_url}" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">` 
                : '';
            
            const badge = isNew ? '<span class="new-badge">(æ–°!)</span>' : '';
            
            // åŠ å…¥ id å±¬æ€§æ–¹ä¾¿åˆªé™¤æ™‚å®šä½
            return `
                <div id="post-${post.id}" class="post-card">
                    <h3>${post.title} ${badge}</h3>
                    <p style="white-space: pre-wrap;">${post.content}</p>
                    ${imgHtml}
                    <div style="margin-top: 15px;">
                        <button onclick="deletePost('${post.id}')" style="font-size: 0.8em; padding: 5px 10px;">ğŸ—‘ åˆªé™¤</button>
                    </div>
                </div>
            `;
        }

        // Realtime ç›£è½
        function setupRealtime() {
            supabaseClient
                .channel('public:posts')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, (payload) => {
                    console.log('Realtime:', payload);
                    const container = document.getElementById('post-container');
                    // æ’å…¥åˆ°æœ€ä¸Šæ–¹
                    container.insertAdjacentHTML('afterbegin', renderPostHTML(payload.new, true));
                })
                .subscribe();
        }

        // --- 4. ç¨‹å¼å…¥å£ ---
        (async () => {
            setupRealtime();
            await fetchPosts();
        })();

    </script>
</body>
</html>