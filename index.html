<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ Supabase éƒ¨è½æ ¼</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .post-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--background-alt);
        }
        .new-badge { color: red; font-size: 0.8em; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
        <h1>æˆ‘çš„ Supabase éƒ¨è½æ ¼ ğŸš€</h1>
        <div id="auth-ui">
            <span id="user-display" style="margin-right: 10px; font-weight: bold;">è®€å–ä¸­...</span>
        </div>
    </header>

    <details id="auth-forms">
        <summary>é»æ­¤å±•é–‹ï¼šç™»å…¥æˆ–è¨»å†Š</summary>
        <div style="margin-top: 20px; padding: 20px; border: 1px dashed #ccc;">
            <h3>å¸³è™Ÿç®¡ç†</h3>
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" placeholder="å¯†ç¢¼">
            <br>
            <button onclick="handleSignUp()">è¨»å†Š</button>
            <button onclick="handleSignIn()">ç™»å…¥</button>
            <button onclick="handleSignOut()" style="background-color: #ef4444;">ç™»å‡º</button>
        </div>
    </details>

    <details id="profile-section" style="display: none; margin-bottom: 20px;">
        <summary>ğŸ‘¤ ä¿®æ”¹æˆ‘çš„å€‹äººè³‡æ–™</summary>
        <div style="padding: 15px; border: 1px solid #ddd; margin-top: 10px;">
            <label>æš±ç¨±ï¼š</label>
            <input type="text" id="edit-username" placeholder="è¼¸å…¥ä½ æƒ³é¡¯ç¤ºçš„åå­—">
            <label>é ­åƒåœ–ç‰‡ï¼š</label>
            <input type="file" id="edit-avatar" accept="image/*">
            <button id="btn-update-profile" onclick="updateProfile()" style="margin-top: 10px;">å„²å­˜ä¿®æ”¹</button>
        </div>
    </details>

    <hr>

    <div id="post-section">
        <h2>âœï¸ ç™¼ä½ˆæ–°æ–‡ç« </h2>
        <input type="text" id="post-title" placeholder="æ–‡ç« æ¨™é¡Œ">
        <textarea id="post-content" placeholder="å¯«é»ä»€éº¼..." rows="4"></textarea>
        <label for="post-image">ä¸Šå‚³åœ–ç‰‡ï¼š</label>
        <input type="file" id="post-image" accept="image/*">
        <button id="btn-publish" onclick="createPost()">ç™¼ä½ˆæ–‡ç« </button>
    </div>

    <hr>

    <h2>ğŸ“– æœ€æ–°æ–‡ç« </h2>
    <div id="post-container">è¼‰å…¥ä¸­...</div>

    <script>
        const SUPABASE_URL = 'https://llhiisczjckqcwdvugih.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2y3NauD1KSlPs4U1k5D9KA_hD9OVGXj';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 1. èº«åˆ†é©—è­‰èˆ‡ç‹€æ…‹ç›£è½ ---
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log("--- ç›£æ§é–‹å§‹ --- äº‹ä»¶:", event);
            const profileSection = document.getElementById('profile-section');
            const userDisplay = document.getElementById('user-display');
            const authForms = document.getElementById('auth-forms');
            
            if (session && session.user) {
                console.log("âœ… åµæ¸¬åˆ°ç™»å…¥èº«åˆ†:", session.user.email);
                if (profileSection) profileSection.style.display = 'block'; 
                if (authForms) authForms.removeAttribute('open'); 

                try {
                    // æ¯æ¬¡ç‹€æ…‹æ”¹è®Šï¼ˆåŒ…å«é‡æ•´ï¼‰ï¼Œéƒ½å»è³‡æ–™åº«æŠ“æœ€æ–°è³‡æ–™
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('username')
                        .eq('id', session.user.id)
                        .maybeSingle();

                    if (error) throw error;

                    console.log("ğŸ” è³‡æ–™åº«å›å‚³çš„æœ€æ–°æš±ç¨±:", data ? data.username : "ç„¡è³‡æ–™");

                    if (data && data.username) {
                        document.getElementById('edit-username').value = data.username;
                        userDisplay.innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${data.username}`;
                    } else {
                        userDisplay.innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${session.user.email} (å°šæœªè¨­å®šæš±ç¨±)`;
                    }
                } catch (err) {
                    console.warn("è®€å– Profile å¤±æ•—:", err.message);
                    userDisplay.innerText = `ğŸ‘‹ å“ˆå›‰ï¼Œ${session.user.email}`;
                }
            } else {
                console.log("âŒ ç›®å‰ç‚ºç™»å‡ºç‹€æ…‹");
                if (profileSection) profileSection.style.display = 'none';
                userDisplay.innerText = 'å°šæœªç™»å…¥';
            }
            // ç„¡è«–ç™»å…¥èˆ‡å¦ï¼Œéƒ½è¦æŠ“æ–‡ç« 
            fetchPosts();
        });

        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) alert('è¨»å†Šå¤±æ•—ï¼š' + error.message);
            else alert('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰ã€‚');
        }

        async function handleSignIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
        }

        async function handleSignOut() {
            await supabaseClient.auth.signOut();
            location.reload(); 
        }

        // --- 2. è³‡æ–™æ“ä½œ ---
        async function fetchPosts() {
            const container = document.getElementById('post-container');
            const { data, error } = await supabaseClient
                .from('posts')
                .select('id, title, content, image_url, created_at')
                .order('created_at', { ascending: false });

            if (error) container.innerText = 'éŒ¯èª¤ï¼š' + error.message;
            else {
                if (data.length === 0) container.innerText = 'ç›®å‰æ²’æœ‰æ–‡ç« ã€‚';
                else container.innerHTML = data.map(post => renderPostHTML(post)).join('');
            }
        }

        async function createPost() {
            const titleInput = document.getElementById('post-title');
            const contentInput = document.getElementById('post-content');
            const fileInput = document.getElementById('post-image');
            const btn = document.getElementById('btn-publish');
            
            if (!titleInput.value) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');
            btn.disabled = true;

            try {
                let publicUrl = null;
                const file = fileInput.files[0];
                if (file) {
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                    await supabaseClient.storage.from('images').upload(fileName, file);
                    const { data } = supabaseClient.storage.from('images').getPublicUrl(fileName);
                    publicUrl = data.publicUrl;
                }
                const { error } = await supabaseClient.from('posts').insert([
                    { title: titleInput.value, content: contentInput.value, image_url: publicUrl }
                ]);
                if (error) throw error;
                alert('ç™¼ä½ˆæˆåŠŸï¼');
                titleInput.value = ''; contentInput.value = ''; fileInput.value = '';
            } catch (err) {
                alert('éŒ¯èª¤ï¼š' + err.message);
            } finally {
                btn.disabled = false;
            }
        }

        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            const { error } = await supabaseClient.from('posts').delete().eq('id', postId);
            if (error) alert('åˆªé™¤å¤±æ•—ï¼ˆæ¬Šé™ä¸è¶³ï¼‰ï¼š' + error.message);
            else {
                alert('åˆªé™¤æˆåŠŸ');
                fetchPosts(); // ç°¡å–®èµ·è¦‹ç›´æ¥é‡æ–°æŠ“å–
            }
        }

        // --- 3. ç•™è¨€åŠŸèƒ½ ---
        function renderPostHTML(post) {
            const imgHtml = post.image_url ? `<img src="${post.image_url}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">` : '';
            return `
                <div id="post-${post.id}" class="post-card">
                    <h3>${post.title}</h3>
                    <p style="white-space: pre-wrap;">${post.content}</p>
                    ${imgHtml}
                    <hr style="opacity: 0.3;">
                    <button onclick="toggleComments('${post.id}')">ğŸ’¬ ç•™è¨€</button>
                    <button onclick="deletePost('${post.id}')" style="background: none; color: gray;">ğŸ—‘ åˆªé™¤</button>
                    <div id="comments-${post.id}" style="display: none; margin-top: 15px;">
                        <div id="comment-list-${post.id}">è¼‰å…¥ä¸­...</div>
                        <input type="text" id="input-comment-${post.id}" placeholder="å¯«ä¸‹ç•™è¨€...">
                        <button onclick="submitComment('${post.id}')">é€å‡º</button>
                    </div>
                </div>`;
        }

        async function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            const list = document.getElementById(`comment-list-${postId}`);
            if (section.style.display === 'none') {
                section.style.display = 'block';
                const { data, error } = await supabaseClient
                    .from('comments')
                    .select('content, created_at, profiles(username)')
                    .eq('post_id', postId);
                
                if (error) list.innerText = 'è¼‰å…¥å¤±æ•—';
                else {
                    list.innerHTML = data.length === 0 ? '<small>æš«ç„¡ç•™è¨€</small>' : 
                        data.map(c => `<div><strong>${c.profiles?.username || 'åŒ¿å'}:</strong> ${c.content}</div>`).join('');
                }
            } else section.style.display = 'none';
        }

        async function submitComment(postId) {
            const input = document.getElementById(`input-comment-${postId}`);
            if (!input.value) return;
            const { error } = await supabaseClient.from('comments').insert([{ content: input.value, post_id: postId }]);
            if (error) alert('å¤±æ•—ï¼š' + error.message);
            else { input.value = ''; toggleComments(postId); toggleComments(postId); }
        }

        async function updateProfile() {
            const username = document.getElementById('edit-username').value;
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { error } = await supabaseClient.from('profiles').update({ username }).eq('id', user.id);
            if (error) alert('æ›´æ–°å¤±æ•—');
            else { alert('æ›´æ–°æˆåŠŸï¼'); location.reload(); }
        }

        // å•Ÿå‹•
        fetchPosts();
    </script>
</body>
</html>